# Regras do Projeto EasyDrive - API RESTful para Aluguel de Ve√≠culos

## Stack e Arquitetura
- Python 3.x, Django 5.1.1, Django Rest Framework 3.15.2
- PostgreSQL (principal), MongoDB (logs)
- API RESTful para gerenciamento de usu√°rios, clientes, ve√≠culos e alugu√©is
- Autentica√ß√£o JWT, logs centralizados
- Arquitetura modular por dom√≠nio

## Estrutura de Diret√≥rios (Arquitetura Modular)
- `core/`: Configura√ß√µes Django (settings, urls, wsgi)
- `api/accounts/`: M√≥dulo de Contas (User model, views, serializers, services)
- `api/auth/`: M√≥dulo de Autentica√ß√£o (signin, signup, signout)
- `api/client/`: M√≥dulo de Clientes (Client model, views, serializers)
- `api/vehicle/`: M√≥dulo de Ve√≠culos (Vehicle model, views, serializers)
- `api/rent/`: M√≥dulo de Alugu√©is (Rental model, views, serializers)
- `api/repositories/`: Adaptadores MongoDB (sync/async)
- `api/middleware/`: Middleware customizado
- `api/swagger/`: Documenta√ß√£o Swagger/OpenAPI
- `api/config/mongodb/`: Configura√ß√µes MongoDB (connection handlers)
- `api/utils/`: Utilit√°rios (hooks, helpers)

## üî¥ REGRAS FUNDAMENTAIS (OBRIGAT√ìRIAS)

### 1. Coment√°rios e Documenta√ß√£o
- ‚ùå NUNCA usar coment√°rios inline (# coment√°rio)
- ‚úÖ SEMPRE usar docstrings (Google Style ou NumPy Style)
- ‚úÖ Docstrings em todas as classes e m√©todos p√∫blicos
- ‚úÖ Incluir Attributes, Args, Returns, Raises nas docstrings

### 2. C√≥digo Limpo
- ‚úÖ Seguir PEP 8 e conven√ß√µes do Django
- ‚úÖ C√≥digo claro, conciso e autoexplicativo
- ‚úÖ Nomes descritivos de vari√°veis e fun√ß√µes
- ‚ùå Evitar verbosidade desnecess√°ria

### 3. Performance - N+1 Queries
- ‚úÖ EVITAR N+1 QUERIES A TODO CUSTO
- ‚úÖ Usar select_related() para ForeignKeys
- ‚úÖ Usar prefetch_related() para ManyToMany e reverse FKs
- ‚úÖ Otimizar querysets em m√©todos get_queryset()
- ‚úÖ SEMPRE otimizar list views com select_related/prefetch_related

## Models (Django)
- Localiza√ß√£o: Cada m√≥dulo tem seu pr√≥prio `models.py` (api.accounts.models, api.client.models, etc.)
- UUID como PK para models principais (exceto User que usa int)
- Incluir created_at e updated_at quando apropriado
- Implementar __str__() retornando representa√ß√£o leg√≠vel
- L√≥gica de neg√≥cio no m√©todo save() quando necess√°rio
- Docstrings obrigat√≥rias com Attributes

**Models Principais:**
- `api.accounts.models.User` - Usu√°rio do sistema (AbstractBaseUser, USERNAME_FIELD = 'email')
- `api.client.models.Client` - Cliente (OneToOne com User, UUID PK)
- `api.vehicle.models.Vehicle` - Ve√≠culo (UUID PK, TypeVehicle: Carro/Moto)
- `api.rent.models.Rental` - Aluguel (FK para Client e Vehicle, UUID PK)

## Views (DRF)
- Preferir: generics.CreateAPIView, ListAPIView, UpdateAPIView, DestroyAPIView, RetrieveAPIView, APIView
- Permiss√µes:
  - AllowAny: Apenas para signup e login
  - IsAuthenticated: Padr√£o para todos os endpoints protegidos
- SEMPRE declarar permission_classes explicitamente
- SEMPRE declarar serializer_class e queryset
- SEMPRE usar select_related()/prefetch_related() em list views
- Criar objetos diretamente usando Model.objects.create() ou Model.objects.create_user()
- Retornar Response com mensagens claras
- Sobrescrever m√©todos HTTP (post, get, patch, delete) para l√≥gica customizada

**Service Layer:**
- Usar camada de servi√ßo para l√≥gica de neg√≥cio complexa
- Services em `{module}/service.py`
- Exemplos: `UserService` (api.accounts.service), `AuthenticationService` (api.auth.service)

## Serializers (DRF)
- Usar ModelSerializer sempre que poss√≠vel
- Declarar Meta com model e fields
- Usar extra_kwargs para configura√ß√µes de campos
- Valida√ß√µes complexas no m√©todo validate() ou validate_<field>()
- Serializers aninhados para relacionamentos (read-only)
- Valida√ß√µes no serializer, N√ÉO na view

**Serializers Principais:**
- `UserSerializer` - Serializa√ß√£o de usu√°rio (com avatar)
- `UserUpdateSerializer` - Atualiza√ß√£o de usu√°rio (com valida√ß√£o de email)
- `ClientSerializer` - Serializa√ß√£o de cliente (com user_data aninhado)
- `ClientDetailsSerializer` - Detalhes completos do cliente
- `VehicleSerializer` - Serializa√ß√£o de ve√≠culo
- `RentSerializer` - Cria√ß√£o de aluguel (com valida√ß√µes de data e disponibilidade)
- `RentListSerializer` - Listagem com dados aninhados usando relacionamentos (client_data, vehicle_data)
- `RentDetailSerializer` - Detalhes completos com dados aninhados
- `RentServiceUpdateSerializer` - Atualiza√ß√£o (devolu√ß√£o) com valida√ß√µes

**Uso de Relacionamentos em Serializers:**
- Serializers aninhados usam `source='client'` e `source='vehicle'` para acessar ForeignKeys
- Campos read_only para dados aninhados: `client_data = ClientDetailsSerializer(source='client', read_only=True)`
- Valida√ß√µes de relacionamentos no m√©todo `validate()` do serializer

## Repositories (MongoDB)
- Localiza√ß√£o: `api/repositories/`
- Usar MongoAdapter (sync) ou AsyncMongoAdapter (async)
- M√©todos: find_one, find_many, insert_one, update_one, delete_one, aggregate, count_documents
- Usa Null Object Pattern para falhas de conex√£o

## Middleware
- LogErroMiddleware: Captura erros autom√°ticos e salva no MongoDB
- Respeitar ordem no settings.MIDDLEWARE
- Sanitiza√ß√£o: Remove dados sens√≠veis (passwords, tokens) dos logs
- Localiza√ß√£o: `api/middleware/middlewares.py`

## Documenta√ß√£o Swagger
- Usar @extend_schema do drf-spectacular
- Tags: Categorizar endpoints por dom√≠nio
- Examples: Fornecer exemplos de request/response
- Filters: Usar hook filter_endpoints_by_allowed_tags
- Mixins dispon√≠veis: `UserCreateSwaggerMixin` (api.swagger.user_mixin)

## Autentica√ß√£o e Seguran√ßa
- JWT: djangorestframework-simplejwt
- Endpoints: 
  - `/api/token/` - Obter access/refresh tokens (padr√£o DRF)
  - `/api/token/refresh/` - Renovar access token
  - `/api/v1/login` - Login customizado (SignInView)
  - `/api/v1/signup` - Cadastro de usu√°rio (SignUpView)
  - `/api/v1/logout` - Logout com blacklist (SignOutView)
- Headers: Authorization: Bearer <access_token>
- Tokens rotativos com blacklist habilitado
- Access token: 24 horas
- Refresh token: 8 dias
- User Model: `api.accounts.User` (AbstractBaseUser, USERNAME_FIELD = 'email')

## Vari√°veis de Ambiente
- Sempre usar .env para configura√ß√µes sens√≠veis
- PostgreSQL: NOME_DO_BANCO, USUARIO_DO_BANCO, SENHA_DO_BANCO, HOST_DO_BANCO, PORTA_DO_BANCO
- MongoDB: MONGO_USERNAME, MONGO_PASSWORD, MONGO_HOST, MONGO_DB_NAME

## Arquitetura Modular

O projeto est√° organizado em m√≥dulos por dom√≠nio:

1. **api.accounts** - Gerenciamento de usu√°rios
   - `models.py` - User (AbstractBaseUser)
   - `serializer.py` - UserSerializer, UserUpdateSerializer
   - `views.py` - UserView (GET, PATCH)
   - `service.py` - UserService (l√≥gica de neg√≥cio)
   - `validation.py` - UserValidatorMixin
   - `urls.py` - Rotas do m√≥dulo

2. **api.auth** - Autentica√ß√£o
   - `views.py` - SignInView, SignUpView, SignOutView
   - `service.py` - AuthenticationService
   - `validations.py` - SiginValidationMixin
   - `types.py` - Type hints (TypedDict)
   - `urls.py` - Rotas do m√≥dulo

3. **api.client** - Gerenciamento de clientes
   - `models.py` - Client (UUID PK)
   - `serializer.py` - ClientSerializer, ClientDetailsSerializer
   - `views.py` - Views CRUD de cliente
   - `urls.py` - Rotas do m√≥dulo

4. **api.vehicle** - Gerenciamento de ve√≠culos
   - `models.py` - Vehicle, TypeVehicle (UUID PK)
   - `serializer.py` - VehicleSerializer
   - `views.py` - Views CRUD de ve√≠culo
   - `urls.py` - Rotas do m√≥dulo

5. **api.rent** - Gerenciamento de alugu√©is
   - `models.py` - Rental (UUID PK)
   - `serializer.py` - RentSerializer, RentListSerializer, RentServiceUpdateSerializer
   - `views.py` - Views CRUD de aluguel
   - `urls.py` - Rotas do m√≥dulo

**Ordem de depend√™ncias no INSTALLED_APPS:**
1. `api.accounts` (base - define User)
2. `api.vehicle` (sem depend√™ncias de outros m√≥dulos)
3. `api.client` (depende de accounts)
4. `api.rent` (depende de vehicle e client)

## Checklist de Implementa√ß√£o (SEMPRE VERIFICAR)
Antes de criar qualquer c√≥digo:
- [ ] Docstrings em todas as classes e m√©todos p√∫blicos
- [ ] Sem coment√°rios inline
- [ ] select_related/prefetch_related em list views
- [ ] Permiss√µes expl√≠citas nas views
- [ ] Valida√ß√µes no serializer, n√£o na view
- [ ] Response com mensagens claras
- [ ] Tratamento de exce√ß√µes adequado
- [ ] C√≥digo PEP 8 compliant
- [ ] Nomes descritivos e autoexplicativos
- [ ] Criar objetos diretamente (Model.objects.create() ou Model.objects.create_user())
- [ ] Usar Service Layer para l√≥gica de neg√≥cio complexa
- [ ] Respeitar arquitetura modular (cada dom√≠nio em seu m√≥dulo)
- [ ] Testes automatizados para novas funcionalidades

## Lembretes Cr√≠ticos
1. SEMPRE usar docstrings, nunca coment√°rios inline
2. SEMPRE otimizar queries com select_related/prefetch_related
3. SEMPRE criar objetos diretamente (sem Builders)
4. SEMPRE declarar permiss√µes explicitamente nas views
5. SEMPRE fazer valida√ß√µes no serializer, n√£o na view
6. NUNCA causar N+1 queries
7. NUNCA adicionar funcionalidades al√©m do pedido
8. SEMPRE escrever testes automatizados para novas funcionalidades
9. SEMPRE usar Service Layer para l√≥gica de neg√≥cio complexa
10. SEMPRE respeitar a arquitetura modular (cada dom√≠nio em seu m√≥dulo)

## Padr√µes de Projeto

### Repository Pattern
- `MongoAdapter` (s√≠ncrono) - `api/repositories/mongo_adapter.py`
- `AsyncMongoAdapter` (ass√≠ncrono) - `api/repositories/async_mongo_adapter.py`
- M√©todos: find_one, find_many, insert_one, update_one, delete_one, aggregate, count_documents

### Null Object Pattern
- `NullCollection`, `NullDBConnection` - Resili√™ncia para falhas de conex√£o MongoDB
- `AsyncNullCollection`, `AsyncNullDBConnection` - Vers√µes ass√≠ncronas
- Localiza√ß√£o: `api/config/mongodb/connection.py` e `async_connection.py`

### Service Layer Pattern
- `UserService` - `api/accounts/service.py` (gerenciamento de avatar)
- `AuthenticationService` - `api/auth/service.py` (signin/signup)

## Refer√™ncias
- Arquivo completo: `.github/copilot-instructions.md`
- Resumo r√°pido: `api/docs/pedindo_para_ia/REGRAS_PROJETO.md`
- README: `README.md`
