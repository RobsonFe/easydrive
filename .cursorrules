# Regras do Projeto EasyDrive - API RESTful para Aluguel de Ve√≠culos

## Stack e Arquitetura
- Python 3.x, Django 5.1.1, Django Rest Framework 3.15.2
- PostgreSQL (principal), MongoDB (logs), Redis (WebSocket), Channels
- API RESTful para gerenciamento de usu√°rios, clientes, ve√≠culos e alugu√©is
- Autentica√ß√£o JWT, logs centralizados, notifica√ß√µes em tempo real

## Estrutura de Diret√≥rios
- `core/`: Configura√ß√µes Django (settings, urls, asgi, wsgi)
- `api/model/`: Modelos de dom√≠nio (User, Client, Vehicle, Rental)
- `api/serializers/`: Serializers DRF
- `api/views/`: Views baseadas em GenericAPIView
- `api/build/`: Builders (Padr√£o Builder) - OBRIGAT√ìRIO
- `api/repositories/`: Adaptadores MongoDB (sync/async)
- `api/middleware/`: Middleware customizado
- `api/swagger/`: Documenta√ß√£o Swagger/OpenAPI
- `api/consumers.py`: WebSocket consumers
- `api/routing.py`: Rotas WebSocket

## üî¥ REGRAS FUNDAMENTAIS (OBRIGAT√ìRIAS)

### 1. Coment√°rios e Documenta√ß√£o
- ‚ùå NUNCA usar coment√°rios inline (# coment√°rio)
- ‚úÖ SEMPRE usar docstrings (Google Style ou NumPy Style)
- ‚úÖ Docstrings em todas as classes e m√©todos p√∫blicos
- ‚úÖ Incluir Attributes, Args, Returns, Raises nas docstrings

### 2. C√≥digo Limpo
- ‚úÖ Seguir PEP 8 e conven√ß√µes do Django
- ‚úÖ C√≥digo claro, conciso e autoexplicativo
- ‚úÖ Nomes descritivos de vari√°veis e fun√ß√µes
- ‚ùå Evitar verbosidade desnecess√°ria

### 3. Performance - N+1 Queries
- ‚úÖ EVITAR N+1 QUERIES A TODO CUSTO
- ‚úÖ Usar select_related() para ForeignKeys
- ‚úÖ Usar prefetch_related() para ManyToMany e reverse FKs
- ‚úÖ Otimizar querysets em m√©todos get_queryset()
- ‚úÖ SEMPRE otimizar list views com select_related/prefetch_related

## Models (Django)
- Localiza√ß√£o: `api/model/`
- UUID como PK para models principais (exceto User)
- Incluir created_at e updated_at quando apropriado
- Implementar __str__() retornando representa√ß√£o leg√≠vel
- L√≥gica de neg√≥cio no m√©todo save() quando necess√°rio
- Docstrings obrigat√≥rias com Attributes

## Views (DRF)
- Preferir: generics.CreateAPIView, ListAPIView, UpdateAPIView, DestroyAPIView
- Permiss√µes:
  - AllowAny: Apenas para cria√ß√£o de usu√°rio e login
  - IsAuthenticated: Padr√£o para todos os endpoints protegidos
- SEMPRE declarar permission_classes explicitamente
- SEMPRE declarar serializer_class e queryset
- SEMPRE usar select_related()/prefetch_related() em list views
- Usar builders para cria√ß√£o de objetos (OBRIGAT√ìRIO)
- Retornar Response com mensagens claras
- Sobrescrever m√©todos HTTP (post, get, patch, delete) para l√≥gica customizada

## Serializers (DRF)
- Usar ModelSerializer sempre que poss√≠vel
- Declarar Meta com model e fields
- Usar extra_kwargs para configura√ß√µes de campos
- Valida√ß√µes complexas no m√©todo validate() ou validate_<field>()
- Serializers aninhados para relacionamentos (read-only)
- Valida√ß√µes no serializer, N√ÉO na view

## Builders (Padr√£o Builder) - OBRIGAT√ìRIO
- Localiza√ß√£o: `api/build/`
- Uso Obrigat√≥rio: Para cria√ß√£o de User, Client, Vehicle, Rental
- M√©todos set_<field>() retornam self para flu√™ncia
- M√©todo build() cria e retorna o objeto
- Valida√ß√µes b√°sicas no build()
- Docstrings com exemplos de uso

## Repositories (MongoDB)
- Localiza√ß√£o: `api/repositories/`
- Usar MongoAdapter (sync) ou AsyncMongoAdapter (async)
- M√©todos: find_one, find_many, insert_one, update_one, delete_one, aggregate
- Usa Null Object Pattern para falhas de conex√£o

## Middleware
- LogErroMiddleware: Captura erros autom√°ticos e salva no MongoDB
- Respeitar ordem no settings.MIDDLEWARE
- Sanitiza√ß√£o: Remove dados sens√≠veis (passwords, tokens) dos logs

## WebSocket (Channels)
- Consumer: Herdar de AsyncWebsocketConsumer
- M√©todos: connect(), disconnect(), receive(), send_notification()
- Groups: Usar channel_layer.group_send() para broadcast
- Routing: Definir em api/routing.py

## Documenta√ß√£o Swagger
- Usar @extend_schema do drf-spectacular
- Tags: Categorizar endpoints por dom√≠nio
- Examples: Fornecer exemplos de request/response
- Filters: Usar hook filter_endpoints_by_allowed_tags

## Autentica√ß√£o e Seguran√ßa
- JWT: djangorestframework-simplejwt
- Endpoints: /api/token/, /api/token/refresh/, /api/v1/login/, /api/v1/logout/
- Headers: Authorization: Bearer <access_token>
- Tokens rotativos com blacklist habilitado

## Vari√°veis de Ambiente
- Sempre usar .env para configura√ß√µes sens√≠veis
- PostgreSQL: NOME_DO_BANCO, USUARIO_DO_BANCO, SENHA_DO_BANCO, HOST_DO_BANCO, PORTA_DO_BANCO
- MongoDB: MONGO_USERNAME, MONGO_PASSWORD, MONGO_HOST, MONGO_DB_NAME

## Checklist de Implementa√ß√£o (SEMPRE VERIFICAR)
Antes de criar qualquer c√≥digo:
- [ ] Docstrings em todas as classes e m√©todos p√∫blicos
- [ ] Sem coment√°rios inline
- [ ] select_related/prefetch_related em list views
- [ ] Permiss√µes expl√≠citas nas views
- [ ] Valida√ß√µes no serializer, n√£o na view
- [ ] Response com mensagens claras
- [ ] Tratamento de exce√ß√µes adequado
- [ ] C√≥digo PEP 8 compliant
- [ ] Nomes descritivos e autoexplicativos
- [ ] Builders usados para cria√ß√£o de objetos
- [ ] Testes automatizados para novas funcionalidades

## Lembretes Cr√≠ticos
1. SEMPRE usar docstrings, nunca coment√°rios inline
2. SEMPRE otimizar queries com select_related/prefetch_related
3. SEMPRE usar builders para cria√ß√£o de objetos
4. SEMPRE declarar permiss√µes explicitamente nas views
5. SEMPRE fazer valida√ß√µes no serializer, n√£o na view
6. NUNCA causar N+1 queries
7. NUNCA adicionar funcionalidades al√©m do pedido
8. SEMPRE escrever testes automatizados para novas funcionalidades

## Refer√™ncias
- Arquivo completo: `.github/copilot-instructions.md`
- Resumo r√°pido: `api/docs/pedindo_para_ia/REGRAS_PROJETO.md`

